<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit System Test - PDF Summary App</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        .test-card.success {
            border-left-color: #28a745;
        }
        .test-card.error {
            border-left-color: #dc3545;
        }
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .test-result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="test-container">
        <header style="text-align: center; margin-bottom: 30px;">
            <h1>ðŸ§ª Credit System Test</h1>
            <p>Test all credit system endpoints to verify functionality</p>
        </header>

        <!-- Health Check -->
        <div class="test-card">
            <h3>1. Server Health Check</h3>
            <p>Check if the server is running and responsive</p>
            <div class="test-buttons">
                <button class="btn-primary" onclick="testEndpoint('/api/health', 'healthResult')">Test Health</button>
                <button class="btn-secondary" onclick="testEndpoint('/api/info', 'healthResult')">Test API Info</button>
            </div>
            <div id="healthResult" class="test-result">Click a button to test...</div>
        </div>

        <!-- Credit System -->
        <div class="test-card">
            <h3>2. Credit System</h3>
            <p>Test credit balance, costs, and transactions</p>
            <div class="test-buttons">
                <button class="btn-primary" onclick="testEndpoint('/api/credits/balance', 'creditResult')">Get Balance</button>
                <button class="btn-primary" onclick="testEndpoint('/api/summary/credit-costs', 'creditResult')">Get Credit Costs</button>
                <button class="btn-secondary" onclick="testEndpoint('/api/credits/transactions', 'creditResult')">Get Transactions</button>
            </div>
            <div id="creditResult" class="test-result">Click a button to test...</div>
        </div>

        <!-- Credit Purchases -->
        <div class="test-card">
            <h3>3. Credit Purchases (Demo)</h3>
            <p>Test credit purchase functionality</p>
            <div class="test-buttons">
                <button class="btn-success" onclick="purchaseCredits('FREE')">Free Tier (10 credits)</button>
                <button class="btn-primary" onclick="purchaseCredits('BASIC')">Basic (100 credits)</button>
                <button class="btn-primary" onclick="purchaseCredits('PRO')">Pro (500 credits)</button>
                <button class="btn-secondary" onclick="purchaseCredits('ENTERPRISE')">Enterprise (2000 credits)</button>
            </div>
            <div id="purchaseResult" class="test-result">Click a button to test purchase...</div>
        </div>

        <!-- Summary Endpoints -->
        <div class="test-card">
            <h3>4. Summary Endpoints</h3>
            <p>Test summary generation endpoints (will fail without PDF upload)</p>
            <div class="test-buttons">
                <button class="btn-secondary" onclick="testEndpoint('/api/summary/usage', 'summaryResult')">Get Usage</button>
            </div>
            <div id="summaryResult" class="test-result">Click a button to test...</div>
        </div>

        <!-- System Status -->
        <div class="test-card">
            <h3>5. System Status</h3>
            <div id="systemStatus">
                <p>Testing system status...</p>
            </div>
        </div>
    </div>

    <script>
        // Generate a demo auth token
        function getAuthToken() {
            let token = localStorage.getItem('demoAuthToken');
            if (!token) {
                token = 'demo-token-' + Date.now();
                localStorage.setItem('demoAuthToken', token);
            }
            return token;
        }

        // Test any GET endpoint
        async function testEndpoint(url, resultElementId) {
            const resultElement = document.getElementById(resultElementId);
            resultElement.innerHTML = '<span class="status info">Testing...</span>';
            
            try {
                const startTime = Date.now();
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                const responseTime = Date.now() - startTime;
                
                const data = await response.json();
                
                let statusClass = response.ok ? 'success' : 'error';
                let statusText = response.ok ? 'SUCCESS' : 'ERROR';
                
                resultElement.innerHTML = `
                    <span class="status ${statusClass}">${statusText} - ${response.status} (${responseTime}ms)</span>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                
                // Update the test card appearance
                resultElement.parentElement.parentElement.className = 
                    `test-card ${response.ok ? 'success' : 'error'}`;
                    
            } catch (error) {
                resultElement.innerHTML = `
                    <span class="status error">ERROR - Network Failure</span>
                    <pre>${error.message}</pre>
                `;
                resultElement.parentElement.parentElement.className = 'test-card error';
            }
        }

        // Test credit purchase
        async function purchaseCredits(packageId) {
            const resultElement = document.getElementById('purchaseResult');
            resultElement.innerHTML = '<span class="status info">Processing purchase...</span>';
            
            try {
                const response = await fetch('/api/credits/purchase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({ packageId })
                });
                
                const data = await response.json();
                
                let statusClass = response.ok ? 'success' : 'error';
                let statusText = response.ok ? 'PURCHASE SUCCESSFUL' : 'PURCHASE FAILED';
                
                resultElement.innerHTML = `
                    <span class="status ${statusClass}">${statusText} - ${response.status}</span>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                
            } catch (error) {
                resultElement.innerHTML = `
                    <span class="status error">PURCHASE FAILED - Network Error</span>
                    <pre>${error.message}</pre>
                `;
            }
        }

        // Test all endpoints on page load
        async function runAllTests() {
            const statusElement = document.getElementById('systemStatus');
            
            try {
                // Test health endpoint
                const healthResponse = await fetch('/api/health');
                const healthData = await healthResponse.json();
                
                // Test credits endpoint
                const creditsResponse = await fetch('/api/credits/balance', {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                const creditsData = await creditsResponse.ok ? await creditsResponse.json() : { error: 'Failed to get credits' };
                
                statusElement.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="test-card success">
                            <h4>Server Status</h4>
                            <p><strong>Status:</strong> <span class="status success">RUNNING</span></p>
                            <p><strong>Version:</strong> ${healthData.version}</p>
                            <p><strong>Environment:</strong> ${healthData.environment}</p>
                        </div>
                        <div class="test-card ${creditsResponse.ok ? 'success' : 'error'}">
                            <h4>Credit System</h4>
                            <p><strong>Status:</strong> <span class="status ${creditsResponse.ok ? 'success' : 'error'}">${creditsResponse.ok ? 'ACTIVE' : 'ISSUES'}</span></p>
                            <p><strong>Credits:</strong> ${creditsData.credits || 'N/A'}</p>
                            <p><strong>User ID:</strong> ${creditsData.userId || 'demo-user'}</p>
                        </div>
                    </div>
                    <p style="margin-top: 15px; text-align: center;">
                        <strong>System Ready:</strong> <span class="status success">ALL SYSTEMS GO</span>
                    </p>
                `;
                
            } catch (error) {
                statusElement.innerHTML = `
                    <div class="test-card error">
                        <h4>System Status</h4>
                        <p><strong>Status:</strong> <span class="status error">ERROR</span></p>
                        <p><strong>Message:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            runAllTests();
            // Auto-test health endpoint
            testEndpoint('/api/health', 'healthResult');
        });

        // Add some basic styles if style.css is missing
        if (!document.querySelector('link[href="css/style.css"]')) {
            const style = document.createElement('style');
            style.textContent = `
                .btn-primary { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
                .btn-secondary { background: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
                .btn-success { background: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
                .btn-primary:hover { background: #0056b3; }
                .btn-secondary:hover { background: #545b62; }
                .btn-success:hover { background: #218838; }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>
</html>